<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>setting up Let’s Encrypt on my private kuberntes cluster | Carlos Millani</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="setting up Let’s Encrypt on my private kuberntes cluster" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve been using self signed certificates for a while, but safari started complaining about them with no simple option to simply trust the certificated as I had before. So, I decided to work on something I’ve been postponing for a while: using let’s encrypt to generate trusted certificates." />
<meta property="og:description" content="I’ve been using self signed certificates for a while, but safari started complaining about them with no simple option to simply trust the certificated as I had before. So, I decided to work on something I’ve been postponing for a while: using let’s encrypt to generate trusted certificates." />
<link rel="canonical" href="http://localhost:4000/personal/2021/07/18/lets-encrypt-on-k8s.html" />
<meta property="og:url" content="http://localhost:4000/personal/2021/07/18/lets-encrypt-on-k8s.html" />
<meta property="og:site_name" content="Carlos Millani" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-18T19:07:00-03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="setting up Let’s Encrypt on my private kuberntes cluster" />
<script type="application/ld+json">
{"description":"I’ve been using self signed certificates for a while, but safari started complaining about them with no simple option to simply trust the certificated as I had before. So, I decided to work on something I’ve been postponing for a while: using let’s encrypt to generate trusted certificates.","headline":"setting up Let’s Encrypt on my private kuberntes cluster","dateModified":"2021-07-18T19:07:00-03:00","datePublished":"2021-07-18T19:07:00-03:00","url":"http://localhost:4000/personal/2021/07/18/lets-encrypt-on-k8s.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/personal/2021/07/18/lets-encrypt-on-k8s.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Carlos Millani" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Carlos Millani</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">setting up Let&#39;s Encrypt on my private kuberntes cluster</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-07-18T19:07:00-03:00" itemprop="datePublished">Jul 18, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’ve been using self signed certificates for a while, but safari started complaining about them with no simple option to simply trust the certificated as I had before. So, I decided to work on something I’ve been postponing for a while: using let’s encrypt to generate trusted certificates.</p>

<p>With an instance of <a href="https://cert-manager.io/docs/">cert-manager</a> running, things were pretty straight-forward. With some annotations on the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">ingress</a> definition, and some configurations about how <em>cert-manager</em> should generate the certificate, everything - generating, renewing ans using certificates - is done automatically.</p>

<p>For my cluster, I’m using an <a href="https://kubernetes.github.io/ingress-nginx/">Nginx Ingress Controller</a>, but I found no restriction about the chosen controller, so others should work too.</p>

<h1 id="cert-manager-resources">Cert-Manager resources</h1>

<p>Cert manager supports a bunch of different strategies to issue certificates. Before, I was using the <a href="https://cert-manager.io/docs/configuration/selfsigned/">self signed</a>, my goal now was to implement <a href="https://cert-manager.io/docs/configuration/acme/">ACME</a>.</p>

<p><em>ACME</em> is a protocol provides a way to automate certificate generation, given a challenge can be fulfilled. There are currently two kinds of challenge:</p>
<ul>
  <li>HTTP01 - Where to prove that you own the subdomain you should be able to serve a certain file from your server</li>
  <li>DNS01 - Here a TXT record is created in your DNS server</li>
</ul>

<p>Let’s Encrypt and Cart-Manager both have good documentation on ACME and its challenges, so let’s focus on the implementation.</p>

<p>The HTTP challenge would not be possible, since my servers are not exposed and thus Let’s Encrypt servers would not be able to reach them to verify the file, so we needed to use the DNS one. <a href="https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers">There is a page</a> with supported DNS providers, anything outside that list does not mean it would be impossible, but it would require more work, for example, using a <a href="https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers">webhook</a>.</p>

<p>I choose to migrate my DNS to cloudflare since it is free and supported (note, I have no association with them), so I just needed to create two resources:</p>
<ul>
  <li>A <code class="language-plaintext highlighter-rouge">Secret</code> to hold my <em>API-TOKEN</em></li>
  <li>A <code class="language-plaintext highlighter-rouge">ClusterIssuer</code> to listen to requests and generate certificates to my ingresses</li>
</ul>

<p>Since I want every namespace to be able to issue a certificate, I used a <code class="language-plaintext highlighter-rouge">ClusterIssuer</code>, not just an <code class="language-plaintext highlighter-rouge">Issuer</code>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cloudflare-api-token-secret</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">stringData</span><span class="pi">:</span>
  <span class="na">api-token</span><span class="pi">:</span> <span class="s">&lt;Your-Token&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cloudflare-letsencrypt-issuer</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">acme</span><span class="pi">:</span>
    <span class="na">email</span><span class="pi">:</span> <span class="s">&lt;your-mail@example.com&gt;</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://acme-v02.api.letsencrypt.org/directory</span>
    <span class="na">privateKeySecretRef</span><span class="pi">:</span>
      <span class="c1"># Secret resource that will be used to store the account's private key.</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">cloudflare-letsencrypt-issuer-account-key</span>
    <span class="na">solvers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">dns01</span><span class="pi">:</span>
        <span class="na">cloudflare</span><span class="pi">:</span>
          <span class="na">email</span><span class="pi">:</span> <span class="s">&lt;your-mail@example.com&gt;</span>
          <span class="na">apiTokenSecretRef</span><span class="pi">:</span>
            <span class="c1"># Name of the secret created on the other resource</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">cloudflare-api-token-secret</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">api-token</span></code></pre></figure>

<p>The resources above needs <em>Cert Manager</em> to be configured already, and once applied we can move to the next step, that is telling our ingress to use this new <code class="language-plaintext highlighter-rouge">ClusterIssuer</code>.</p>

<h1 id="ingress-resource">Ingress Resource</h1>

<p>I’ll give here the example of how my grafana ingress came out, commenting above the important lines.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="c1"># Tells Cert Manager to generate a certificate using our configured ClusterIssuer</span>
    <span class="s">cert-manager.io/cluster-issuer</span><span class="pi">:</span> <span class="s">cloudflare-letsencrypt-issuer</span>
    <span class="s">nginx.ingress.kubernetes.io/auth-realm</span><span class="pi">:</span> <span class="s">Authentication Required</span>
    <span class="s">nginx.ingress.kubernetes.io/auth-secret</span><span class="pi">:</span> <span class="s">basic-auth</span>
    <span class="s">nginx.ingress.kubernetes.io/auth-type</span><span class="pi">:</span> <span class="s">basic</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">grafana</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">host</span><span class="pi">:</span> <span class="s">grafana.homelab.cadumillani.com.br</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">backend</span><span class="pi">:</span>
          <span class="na">service</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">grafana</span>
            <span class="na">port</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">pathType</span><span class="pi">:</span> <span class="s">Prefix</span>
  <span class="na">tls</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">grafana.homelab.cadumillani.com.br</span>
    <span class="c1"># Secret that Cert Manager will create with certificate</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">homelab-grafana-ingress-le-cert</span></code></pre></figure>

<p>Basically, using the <code class="language-plaintext highlighter-rouge">cert-manager.io/cluster-issuer</code> annotation we tell Cert Manager that we want it to use the given <code class="language-plaintext highlighter-rouge">ClusterIssuer</code> to issue a certificate, and it uses the <code class="language-plaintext highlighter-rouge">tls</code> section of the <em>yaml</em> to know which domain to issue to certificate to, and where to store it after it’s generated.</p>

<h1 id="conclusion">Conclusion</h1>

<p>I was expecting the configuration of the DNS01 challenge to give me much more trouble, I’m really impressed of how smooth that went, given <em>Cert Manager</em> and an <em>Ingress Controller</em> already configured.</p>

<p>It is a challenge to administrate a kubernetes cluster, and there is a long way before I can say comfortably that I know how to do that, but this kind of integration makes the effort seems kinda worth it!</p>

<p><img src="/assets/lets-encrypt-on-k8s/encrypted-grafana.png" alt="Trusted Certificate on grafana" /></p>

  </div><a class="u-url" href="/personal/2021/07/18/lets-encrypt-on-k8s.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Carlos Millani</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Carlos Millani</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/cmillani"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">cmillani</span></a></li><li><a href="https://www.linkedin.com/in/cemillani"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">cemillani</span></a></li><li><a href="https://www.twitter.com/cadumillani"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">cadumillani</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My name is Carlos, I&#39;m a software engineer and this is a place where I&#39;ll share some of my thought and experiments  on computer science. Some academic stuff, other hobby and tinkering projects, and enterprise insights.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
